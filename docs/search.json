[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "YCT Trends - Snake River Assessment",
    "section": "",
    "text": "1 Introduction\nThis book describes long-term trends in population density for Yellowstone cutthroat trout (YCT) in the upper Snake River watershed, Wyoming, USA. All YCT data were provided by the Wyoming Game and Fish Department. Our goals are to describe long-term trends in YCT population density using multiple datasets (mark-recapture population estimates, redd counts, and spawning population enumeration using a weir) and evaluate variation in trends among populations.\nThis information is preliminary or provisional and is subject to revision. It is being provided to meet the need for timely best science. The information has not received final approval by the U.S. Geological Survey (USGS) and is provided on the condition that neither the USGS nor the U.S. Government shall be held liable for any damages resulting from the authorized or unauthorized use of the information.\nProject team: Jeff Baldock and Annika Walters\n\n\nSession Information\n\n\n\n\n\nCode\nsessionInfo()\n\n\nR version 4.4.3 (2025-02-28 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 22631)\n\nMatrix products: default\n\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/Denver\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] htmlwidgets_1.6.4 compiler_4.4.3    fastmap_1.2.0     cli_3.6.3        \n [5] tools_4.4.3       htmltools_0.5.8.1 rstudioapi_0.17.1 rmarkdown_2.29   \n [9] knitr_1.48        jsonlite_1.8.9    xfun_0.49         digest_0.6.37    \n[13] rlang_1.1.4       evaluate_1.0.1",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Introduction</span>"
    ]
  },
  {
    "objectID": "DataViz.html",
    "href": "DataViz.html",
    "title": "2  Data Visualization",
    "section": "",
    "text": "2.1 Data\nPurpose: visualize long-term population estimate, redd count, and spawning weir data from multiple YCT populations in the upper Snake River watershed.\nCode\n# mark-recapture population estimates\npopest &lt;- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/WyACT/Snake River Assessment/Population data/PopulationEstimates_WGFD_1988-2022_cleaned.csv\") %&gt;%\n  mutate(Nperkm_total = Npermile_total/1.60934)\n\n# spring creek redd counts\nreddcts &lt;- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/WyACT/Snake River Assessment/Population data/ReddCounts_WGFD_1971-2021_cleaned.csv\")\n\n# lower bar bc weir (latent run size following run timing model)\nweir &lt;- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/WyACT/Snake River Assessment/Population data/RunTiming_TopModel_MalFem2_ParameterSummary.csv\")\nnames(weir) &lt;- c(\"param\", \"mean\", \"sd\", \"ci025\", \"ci_250\", \"ci_500\", \"ci_750\", \"ci_975\", \"Rhat\", \"n.eff\")\nweirtib &lt;- tibble(year = rep(NA, times = 55),\n                  param = rep(NA, times = 55),\n                  total_mean = rep(NA, times = 55),\n                  total_sd = rep(NA, times = 55))\nweirtib$year &lt;- c(1965:1990, 1992:2015, 2017:2021)\nfor (i in 1:55) {\n  weirtib$param[i] &lt;- unlist(weir[i+174,1]) # parameter name\n  weirtib$total_mean[i] &lt;- unlist(weir[i+174,2]) # mean total run size\n  weirtib$total_sd[i] &lt;- unlist(weir[i+174,3]) # SD total run size\n}",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data Visualization</span>"
    ]
  },
  {
    "objectID": "DataViz.html#mark-recapture",
    "href": "DataViz.html#mark-recapture",
    "title": "2  Data Visualization",
    "section": "2.2 Mark-Recapture",
    "text": "2.2 Mark-Recapture\nView all data:\n\n\nCode\npopest %&gt;% \n  ggplot(aes(x = year, y = Nperkm_total)) +\n  geom_point() + #geom_line() +\n  facet_wrap(~site)\n\n\n\n\n\n\n\n\n\nRestrict to sites with &gt;10 years of data:\n\n\nCode\npopest %&gt;% \n  filter(site %in% c(\"Flat_NowlinSleigh\", \"GrosVentre_ParkBoundary-Kelly\", \"Hoback_LowerHoback\", \"Salt_Narrows-Hwy238\", \"Salt_AuburnGrover-Christiansen\", \"Salt_Etna\", \"Snake_Wilson-SouthPark\", \"Snake_Moose-Wilson\", \"Snake_Deadmans-Moose\")) %&gt;%\n  mutate(site = recode(site, \n                       \"Snake_Deadmans-Moose\" = \"Snake River: Deadmans-Moose\", \n                       \"Snake_Moose-Wilson\" = \"Snake River: Moose-Wilson\", \n                       \"Snake_Wilson-SouthPark\" = \"Snake River: Wilson-South Park\", \n                       \"GrosVentre_ParkBoundary-Kelly\" = \"Gros Ventre River\", \n                       \"Flat_NowlinSleigh\" = \"Flat Creek\", \n                       \"Hoback_LowerHoback\" = \"Hoback River (lower)\",  \n                       \"Salt_AuburnGrover-Christiansen\" = \"Salt River: Auburn-Christiansen\", \n                       \"Salt_Narrows-Hwy238\" = \"Salt River: The Narrows\", \n                       \"Salt_Etna\" = \"Salt River: Etna\")) %&gt;%\n  mutate(site = factor(site, levels = c(\"Snake River: Deadmans-Moose\", \"Snake River: Moose-Wilson\", \"Snake River: Wilson-South Park\", \n                                        \"Gros Ventre River\", \"Flat Creek\", \"Hoback River (lower)\",  \n                                        \"Salt River: Auburn-Christiansen\", \"Salt River: The Narrows\", \"Salt River: Etna\"))) %&gt;%\n  ggplot(aes(x = year, y = Nperkm_total)) +\n  #geom_smooth() +\n  geom_point() +\n  facet_wrap(~site, ncol = 3) + \n  xlab(\"Year\") + ylab(\"YCT per km\") + #ylim(0,900) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))\n\n\n\n\n\n\n\n\n\nAdd LOESS smoothers and plot on unique scales:\n\n\nCode\npopest %&gt;% \n  filter(site %in% c(\"Flat_NowlinSleigh\", \"GrosVentre_ParkBoundary-Kelly\", \"Hoback_LowerHoback\", \"Salt_Narrows-Hwy238\", \"Salt_AuburnGrover-Christiansen\", \"Salt_Etna\", \"Snake_Wilson-SouthPark\", \"Snake_Moose-Wilson\", \"Snake_Deadmans-Moose\")) %&gt;%\n  mutate(site = recode(site, \n                       \"Snake_Deadmans-Moose\" = \"Snake River: Deadmans-Moose\", \n                       \"Snake_Moose-Wilson\" = \"Snake River: Moose-Wilson\", \n                       \"Snake_Wilson-SouthPark\" = \"Snake River: Wilson-South Park\", \n                       \"GrosVentre_ParkBoundary-Kelly\" = \"Gros Ventre River\", \n                       \"Flat_NowlinSleigh\" = \"Flat Creek\", \n                       \"Hoback_LowerHoback\" = \"Hoback River (lower)\",  \n                       \"Salt_AuburnGrover-Christiansen\" = \"Salt River: Auburn-Christiansen\", \n                       \"Salt_Narrows-Hwy238\" = \"Salt River: The Narrows\", \n                       \"Salt_Etna\" = \"Salt River: Etna\")) %&gt;%\n  mutate(site = factor(site, levels = c(\"Snake River: Deadmans-Moose\", \"Snake River: Moose-Wilson\", \"Snake River: Wilson-South Park\", \n                                        \"Gros Ventre River\", \"Flat Creek\", \"Hoback River (lower)\",  \n                                        \"Salt River: Auburn-Christiansen\", \"Salt River: The Narrows\", \"Salt River: Etna\"))) %&gt;%\n  ggplot(aes(x = year, y = Nperkm_total)) +\n  geom_smooth() +\n  geom_point() +\n  facet_wrap(~site, ncol = 3, scales = \"free_y\") + \n  xlab(\"Year\") + ylab(\"YCT per km\") + #ylim(0,900) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data Visualization</span>"
    ]
  },
  {
    "objectID": "DataViz.html#redd-counts",
    "href": "DataViz.html#redd-counts",
    "title": "2  Data Visualization",
    "section": "2.3 Redd Counts",
    "text": "2.3 Redd Counts\nView all data\n\n\nCode\nreddcts %&gt;%\n  ggplot(aes(x = year, y = reddsperkm)) +\n  geom_point() +\n  facet_wrap(~stream) \n\n\n\n\n\n\n\n\n\nDrop Cody Creek (only 4 years or data) and fix names\n\n\nCode\nreddcts %&gt;%\n  filter(stream != \"Cody\") %&gt;%\n  mutate(stream = recode(stream, \"3 Channel\" = \"Three Channel\", \"Snake River Side Channel\" = \"SR Side Channel\")) %&gt;%\n  mutate(stream = factor(stream, levels = c(\"Cowboy Cabin\", \"Upper Bar BC\", \"SR Side Channel\", \"Blacktail\",\n                                            \"Three Channel\", \"Price\", \"Lower Bar BC\", \"Little Bar BC\", \"Fish\", \n                                            \"Flat\", \"Nowlin\", \"Spring\", \"Blue Crane\", \"Dave\", \"Laker\", \"Christiansen\"))) %&gt;%\n  ggplot(aes(x = year, y = reddsperkm)) +\n  #geom_smooth() +\n  geom_point() +\n  facet_wrap(~stream) + \n  xlab(\"Year\") + ylab(\"Redds per km\") + #ylim(0,900) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))\n\n\n\n\n\n\n\n\n\nAdd LOESS smoothers and plot on unique scales:\n\n\nCode\nreddcts %&gt;%\n  filter(stream != \"Cody\") %&gt;%\n  mutate(stream = recode(stream, \"3 Channel\" = \"Three Channel\", \"Snake River Side Channel\" = \"SR Side Channel\")) %&gt;%\n  mutate(stream = factor(stream, levels = c(\"Cowboy Cabin\", \"Upper Bar BC\", \"SR Side Channel\", \"Blacktail\",\n                                            \"Three Channel\", \"Price\", \"Lower Bar BC\", \"Little Bar BC\", \"Fish\", \n                                            \"Flat\", \"Nowlin\", \"Spring\", \"Blue Crane\", \"Dave\", \"Laker\", \"Christiansen\"))) %&gt;%\n  ggplot(aes(x = year, y = reddsperkm)) +\n  geom_smooth() +\n  geom_point() +\n  facet_wrap(~stream, scales = \"free_y\") + \n  xlab(\"Year\") + ylab(\"Redds per km\") + #ylim(0,900) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data Visualization</span>"
    ]
  },
  {
    "objectID": "DataViz.html#weir",
    "href": "DataViz.html#weir",
    "title": "2  Data Visualization",
    "section": "2.4 Weir",
    "text": "2.4 Weir\nPlot time series of YCT spawning abundance in Lower Bar BC (enumerated at the WGFD weir). Abundance data are corrected for interannual variation in monitoring period using a run timing model as in Baldock et al. (2023, CJFAS).\n\n\nCode\nweirtib %&gt;%\n  ggplot(aes(x = year, y = total_mean)) +\n  geom_point() + geom_line() +\n  xlab(\"Year\") + ylab(\"YCT spawning abundance\") + ylim(0,max(weirtib$total_mean)) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))\n\n\n\n\n\n\n\n\n\nAdd LOESS smoother:\n\n\nCode\nweirtib %&gt;%\n  ggplot(aes(x = year, y = total_mean)) +\n  geom_smooth() +\n  geom_point() + geom_line() +\n  xlab(\"Year\") + ylab(\"YCT spawning abundance\") + ylim(0,max(weirtib$total_mean)) +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data Visualization</span>"
    ]
  },
  {
    "objectID": "TrendAnalysis.html",
    "href": "TrendAnalysis.html",
    "title": "3  Trend Analysis",
    "section": "",
    "text": "3.1 Mark-Recapture\nPurpose: use linear regression and Dynamic Factor Analysis (Zuur et al., Ohlberger et al. 2016) to characterize long-term trends in YCT population estimates and redd counts.\nFormat MR data\nCode\npopest &lt;- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/WyACT/Snake River Assessment/Population data/PopulationEstimates_WGFD_1988-2022_cleaned.csv\") %&gt;%\n  mutate(Nperkm_total = Npermile_total/1.60934) %&gt;% \n  filter(site %in% c(\"Flat_NowlinSleigh\", \"GrosVentre_ParkBoundary-Kelly\", \"Hoback_LowerHoback\", \"Salt_Narrows-Hwy238\", \"Salt_AuburnGrover-Christiansen\", \"Salt_Etna\", \"Snake_Wilson-SouthPark\", \"Snake_Moose-Wilson\", \"Snake_Deadmans-Moose\")) %&gt;%\n  mutate(site = recode(site, \n                       \"Snake_Deadmans-Moose\" = \"Snake River: Deadmans-Moose\", \n                       \"Snake_Moose-Wilson\" = \"Snake River: Moose-Wilson\", \n                       \"Snake_Wilson-SouthPark\" = \"Snake River: Wilson-South Park\", \n                       \"GrosVentre_ParkBoundary-Kelly\" = \"Gros Ventre River\", \n                       \"Flat_NowlinSleigh\" = \"Flat Creek\", \n                       \"Hoback_LowerHoback\" = \"Hoback River (lower)\",  \n                       \"Salt_AuburnGrover-Christiansen\" = \"Salt River: Auburn-Christiansen\", \n                       \"Salt_Narrows-Hwy238\" = \"Salt River: The Narrows\", \n                       \"Salt_Etna\" = \"Salt River: Etna\")) %&gt;%\n  mutate(site = factor(site, levels = c(\"Snake River: Deadmans-Moose\", \"Snake River: Moose-Wilson\", \"Snake River: Wilson-South Park\", \n                                        \"Gros Ventre River\", \"Flat Creek\", \"Hoback River (lower)\",  \n                                        \"Salt River: Auburn-Christiansen\", \"Salt River: The Narrows\", \"Salt River: Etna\")))\n\npopest_mat &lt;- popest %&gt;% select(year, site, Nperkm_total) %&gt;% spread(key = site, value = Nperkm_total)\npopest_mat_formatted &lt;- t(scale(popest_mat[,c(2:10)]))",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Trend Analysis</span>"
    ]
  },
  {
    "objectID": "TrendAnalysis.html#mark-recapture",
    "href": "TrendAnalysis.html#mark-recapture",
    "title": "3  Trend Analysis",
    "section": "",
    "text": "3.1.1 Linear trends\nSimple trends using linear regression\n\n\nCode\npopest %&gt;% \n  group_by(site) %&gt;%\n  mutate(pescaled = scale(Nperkm_total)) %&gt;%\n  ungroup() %&gt;%\n  ggplot(aes(x = year, y = pescaled)) +\n  geom_smooth(method = \"lm\", se = TRUE, color = \"blue\", fill = \"blue\", alpha = 0.2) +\n  geom_point() +\n  facet_wrap(~site) +\n  xlab(\"Year\") +\n  ylab(\"YCT per km (standardized)\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))\n\n\n\n\n\n\n\n\n\n\n\n3.1.2 Dynamic Factor Analysis\nUse dynamic factor analysis, DFA, to extract common trends from the population estimate data and estimate the loading of each population onto each trend (Zuur et al. 2003, Ohlberger et al. 2016).\nFit MARSS models with 1-3 underlying trends and equal variance-covariance structure (these models tended to have the greatest support when compared against other var./cov. structures using AIC). Note that models with 4+ trends fail to converge/throw errors.\n\n\nCode\ncntl.list = list(minit = 200, maxit = 5000, allow.degen = FALSE)\nfit_1 &lt;- MARSS(popest_mat_formatted, model = list(m = 1, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\nfit_2 &lt;- MARSS(popest_mat_formatted, model = list(m = 2, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\nfit_3 &lt;- MARSS(popest_mat_formatted, model = list(m = 3, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\n\n\nFit MARSS models with 1-4 underlying trends and differnt variance/covariance structures, then compare using AICc. Note that using “unconstrained” model structure leads to errors.\nUse model selection to determine number of underlying trends: 1-trend model is best.\n\n\nCode\ntibble(\n  model = c(\"1 trend\", \"2 trends\", \"3 trends\"),\n  AICc = round(c(fit_1$AICc, fit_2$AICc, fit_3$AICc), digits = 2)\n) %&gt;% mutate(delta.AICc = round(AICc - min(AICc), digits = 2)) %&gt;% arrange(delta.AICc)\n\n\n# A tibble: 3 × 3\n  model     AICc delta.AICc\n  &lt;chr&gt;    &lt;dbl&gt;      &lt;dbl&gt;\n1 1 trend   314.        0  \n2 2 trends  331.       16.9\n3 3 trends  350.       36.8\n\n\nSet top model\n\n\nCode\ntopmod &lt;- fit_1\n\n\nView diagnostic plots\nUse varimax rotation to determine trends and loadings\n\n\nCode\n# get the inverse of the rotation matrix\nZ.est &lt;- coef(topmod, type = \"matrix\")$Z\nH.inv &lt;- 1\nif (ncol(Z.est) &gt; 1)\nH.inv &lt;- varimax(coef(topmod, type = \"matrix\")$Z)$rotmat\n\n# rotate factor loadings\nZ.rot &lt;- Z.est %*% H.inv\n# rotate trends\ntrends.rot &lt;- solve(H.inv) %*% topmod$states\ntrends.rot.low &lt;- trends.rot - (solve(H.inv) %*% (topmod$states.se*1.95))\ntrends.rot.up &lt;- trends.rot + (solve(H.inv) %*% (topmod$states.se*1.95))\n\n# Add CIs to marssMLE object\ntopmod &lt;- MARSSparamCIs(topmod)\n# Use coef() to get the upper and lower CIs\nZ.low &lt;- coef(topmod, type = \"Z\", what = \"par.lowCI\")\nZ.up &lt;- coef(topmod, type = \"Z\", what = \"par.upCI\")\nZ.rot.up &lt;- Z.up %*% H.inv\nZ.rot.low &lt;- Z.low %*% H.inv\ndf &lt;- data.frame(est = as.vector(Z.rot),\n                 conf.up = as.vector(Z.rot.up),\n                 conf.low = as.vector(Z.rot.low)\n                 )\n\n\nPlot (rotated) common trend and loadings. This figure shows the common trend (left panel) and population-specific trend loadings (right panel; i.e., the extent to which each time series maps onto the common trend). The common trend shows a general pattern of increasing population density, particularly since ca. 2006. This increase is largely driven by the Gros Ventre, Salt River Auburn-Christiansen, and Salt River Narrows populations. In contrast, the Snake River Deadmans-Moose population shows the opposite pattern: a long-term decline. All other populations map weakly onto the common trend (i.e., stable trend in population density).\n\n\nCode\npops &lt;- rownames(popest_mat_formatted)\npops.short &lt;- c(\"SNK1\", \"SNK2\", \"SNK3\", \"GRVE\", \"FLAT\", \"HOBK\", \"SLT1\", \"SLT2\", \"SLT3\")\n\n# Plot common trends with confidence interval\nptrend1 &lt;- ggplot() + \n  geom_ribbon(data = NULL, aes(x = popest_mat$year, ymin = trends.rot.low[1,], ymax = trends.rot.up[1,]), fill = \"grey\") +\n  geom_hline(yintercept = 0, size = 0.5, linetype = \"dashed\") +\n  geom_line(data = NULL, aes(x = popest_mat$year, y = trends.rot[1,]), size = 1) +\n  xlab(\"Year\") +\n  ylab(\"Common trend\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))\n\n# Plot loadings\npload1 &lt;- ggplot(data=NULL, aes(factor(pops.short, levels = pops.short), Z.rot[,1])) + \n  geom_hline(yintercept = 0, size = 0.5, color = \"grey50\") +\n  geom_hline(yintercept = 0.2, size = 0.5, linetype = \"dashed\", color = \"grey50\") +\n  geom_hline(yintercept = -0.2, size = 0.5, linetype = \"dashed\", color = \"grey50\") +\n  geom_bar(stat = \"identity\", width = 0.2, fill = \"black\") +\n  xlab(\"Population\") +\n  ylab(\"Loading\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))\n\n# combine plots\nggarrange(ptrend1, pload1, ncol = 2)\n\n\n\n\n\n\n\n\n\nPlot population-specific trend estimates. These are basically the loadings multiplied by the common trend and show trend estimates for each population individually.\n\n\nCode\n# run kalman filter\nkf &lt;- MARSSkfss(topmod)\n\n# extract model components\nZ_mat &lt;- coef(topmod, type = \"matrix\")$Z  # Loadings (n_series x n_trends)\nxtT &lt;- kf$xtT                               # States (n_trends x time)\nVtT &lt;- kf$VtT                               # State covariance matrices (n_trends x n_trends x time)\n\n# compute fitted values and standard errors\nn_series &lt;- nrow(Z_mat)\nn_time &lt;- ncol(xtT)\n\nfitted_vals &lt;- Z_mat %*% xtT              # n_series x time\nse_vals &lt;- matrix(NA, n_series, n_time)   # standard errors\n\nfor (t in 1:n_time) {\n  Vt &lt;- VtT[, , t]\n  Var_yt &lt;- Z_mat %*% Vt %*% t(Z_mat)\n  se_vals[, t] &lt;- sqrt(diag(Var_yt))      # std dev for each series at time t\n}\n\n# construct 95% confidence intervals\nupper_band &lt;- fitted_vals + 1.96 * se_vals\nlower_band &lt;- fitted_vals - 1.96 * se_vals\n\n# plot\nas_tibble(t(fitted_vals)) %&gt;% \n  mutate(year = popest_mat$year) %&gt;% \n  gather(key = \"stream\", value = \"fitted\", -year) %&gt;% \n  mutate(stream = factor(stream, levels = pops)) %&gt;%\n  left_join(as_tibble(t(upper_band)) %&gt;% \n              mutate(year = popest_mat$year) %&gt;% \n              gather(key = \"stream\", value = \"fitted_up\", -year) %&gt;% \n              mutate(stream = factor(stream, levels = pops))) %&gt;%\n  left_join(as_tibble(t(lower_band)) %&gt;% \n              mutate(year = popest_mat$year) %&gt;% \n              gather(key = \"stream\", value = \"fitted_low\", -year) %&gt;% \n              mutate(stream = factor(stream, levels = pops))) %&gt;%\n  left_join(as_tibble(t(popest_mat_formatted)) %&gt;% \n              mutate(year = popest_mat$year) %&gt;% \n              gather(key = \"stream\", value = \"observed\", -year) %&gt;% \n              mutate(stream = factor(stream, levels = pops))) %&gt;%\n  ggplot() +\n  geom_ribbon(aes(x = year, ymin = fitted_low, ymax = fitted_up), fill = \"blue\", alpha = 0.2) +\n  geom_point(aes(x = year, y = observed)) +\n  geom_line(aes(x = year, y = fitted), color = \"blue\", size = 1) +\n  facet_wrap(~stream) +\n  xlab(\"Year\") +\n  ylab(\"Redds per km (standardized)\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Trend Analysis</span>"
    ]
  },
  {
    "objectID": "TrendAnalysis.html#redd-counts",
    "href": "TrendAnalysis.html#redd-counts",
    "title": "3  Trend Analysis",
    "section": "3.2 Redd Counts",
    "text": "3.2 Redd Counts\nFormat redd count data\n\n\nCode\n# spring creek redd counts\nreddcts &lt;- read_csv(\"C:/Users/jbaldock/OneDrive - DOI/Documents/WyACT/Snake River Assessment/Population data/ReddCounts_WGFD_1971-2021_cleaned.csv\") %&gt;%\n  filter(stream != \"Cody\") %&gt;%\n  mutate(stream = recode(stream, \"3 Channel\" = \"Three Channel\", \"Snake River Side Channel\" = \"SR Side Channel\")) %&gt;%\n  mutate(stream = factor(stream, levels = c(\"Cowboy Cabin\", \"Upper Bar BC\", \"SR Side Channel\", \"Blacktail\",\n                                            \"Three Channel\", \"Price\", \"Lower Bar BC\", \"Little Bar BC\", \"Fish\", \n                                            \"Flat\", \"Nowlin\", \"Spring\", \"Blue Crane\", \"Dave\", \"Laker\", \"Christiansen\")))\n\nreddcts_mat &lt;- reddcts %&gt;% select(year, stream, reddsperkm) %&gt;% spread(key = stream, value = reddsperkm)\nreddcts_mat_formatted &lt;- t(scale(reddcts_mat[,c(2:17)]))\n\n\n\n3.2.1 Linear trends\nSimple trends using linear regression\n\n\nCode\nreddcts %&gt;% \n  group_by(stream) %&gt;%\n  mutate(reddsscaled = scale(reddsperkm)) %&gt;%\n  ungroup() %&gt;%\n  ggplot(aes(x = year, y = reddsscaled)) +\n  geom_smooth(method = \"lm\", se = TRUE, color = \"blue\", fill = \"blue\", alpha = 0.2) +\n  geom_point() +\n  facet_wrap(~stream) +\n  xlab(\"Year\") +\n  ylab(\"Redds per km (standardized)\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))\n\n\n\n\n\n\n\n\n\n\n\n3.2.2 Dynamic Factor Analysis\nUse dynamic factor analysis, DFA, to extract common trends from the redd count data and estimate the loading of each population onto each trend (Zuur et al. 2003, Ohlberger et al. 2016).\nFit MARSS models with 1-4 underlying trends and equal variance-covariance structure (these models tended to have the greatest support when compared against other var./cov. structures using AIC).\n\n\nCode\ncntl.list = list(minit = 200, maxit = 5000, allow.degen = FALSE)\nfit_1 &lt;- MARSS(reddcts_mat_formatted, model = list(m = 1, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\nfit_2 &lt;- MARSS(reddcts_mat_formatted, model = list(m = 2, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\nfit_3 &lt;- MARSS(reddcts_mat_formatted, model = list(m = 3, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\nfit_4 &lt;- MARSS(reddcts_mat_formatted, model = list(m = 4, R = \"equalvarcov\"), form = \"dfa\", silent = TRUE, control = cntl.list)\n\n\nFit MARSS models with 1-4 underlying trends and differnt variance/covariance structures, then compare using AICc. Note that using and “unconstrained” model structure leads to errors.\nUse model selection to determine number of underlying trends: 1-trend model is best, but only slightly better than the 2 trend model.\n\n\nCode\ntibble(\n  model = c(\"1 trend\", \"2 trends\", \"3 trends\", \"4 trends\"),\n  AICc = round(c(fit_1$AICc, fit_2$AICc, fit_3$AICc, fit_4$AICc), digits = 2)\n) %&gt;% mutate(delta.AICc = round(AICc - min(AICc), digits = 2)) %&gt;% arrange(delta.AICc)\n\n\n# A tibble: 4 × 3\n  model     AICc delta.AICc\n  &lt;chr&gt;    &lt;dbl&gt;      &lt;dbl&gt;\n1 1 trend  1145.       0   \n2 2 trends 1146.       1.63\n3 3 trends 1162.      17.0 \n4 4 trends 1188.      43.3 \n\n\nSet top model\n\n\nCode\ntopmod &lt;- fit_1\n\n\nView diagnostic plots\nUse varimax rotation to determine trends and loadings\n\n\nCode\n# get the inverse of the rotation matrix\nZ.est &lt;- coef(topmod, type = \"matrix\")$Z\nH.inv &lt;- 1\nif (ncol(Z.est) &gt; 1)\nH.inv &lt;- varimax(coef(topmod, type = \"matrix\")$Z)$rotmat\n\n# rotate factor loadings\nZ.rot &lt;- Z.est %*% H.inv\n# rotate trends\ntrends.rot &lt;- solve(H.inv) %*% topmod$states\ntrends.rot.low &lt;- trends.rot - (solve(H.inv) %*% (topmod$states.se*1.95))\ntrends.rot.up &lt;- trends.rot + (solve(H.inv) %*% (topmod$states.se*1.95))\n\n# Add CIs to marssMLE object\ntopmod &lt;- MARSSparamCIs(topmod)\n# Use coef() to get the upper and lower CIs\nZ.low &lt;- coef(topmod, type = \"Z\", what = \"par.lowCI\")\nZ.up &lt;- coef(topmod, type = \"Z\", what = \"par.upCI\")\nZ.rot.up &lt;- Z.up %*% H.inv\nZ.rot.low &lt;- Z.low %*% H.inv\ndf &lt;- data.frame(est = as.vector(Z.rot),\n                 conf.up = as.vector(Z.rot.up),\n                 conf.low = as.vector(Z.rot.low)\n                 )\n\n\nPlot (rotated) common trend and loadings. The common trend indicates a period of relative stability (pre-1993) followed a period of increasing redd densities in spring-fed spawning tributaries (1993-2022). This post-1993 period of population increases is interrupted by a short period (ca. 5 years) of decline in the early 2000s. Most populations load positively onto the common trend, but particularly Cowboy Cabin Spring, Upper Bar BC Spring, Price Spring, Flat Creek, Nowlin Creek, and Christiansen Spring. Spring Creek shows the opposite trend, indicating a decline in redd densities since the 1990s (although note that data for this population is only available from 1993 to 2007). Redd densities in all other populations are generally stable over the period of record.\n\n\nCode\npops &lt;- rownames(reddcts_mat_formatted)\npops.short &lt;- c(\"COCA\", \"UBBC\", \"SRSC\", \"BLKT\", \"THCH\", \"PRCE\", \"LOBC\", \"LIBC\", \"FISH\", \"FLAT\", \"NOWL\", \"SPRG\", \"BLCR\", \"DAVE\", \"LAKR\", \"CHRS\")\n\n# Plot common trends with confidence interval\nptrend1 &lt;- ggplot() + \n  geom_ribbon(data = NULL, aes(x = reddcts_mat$year, ymin = trends.rot.low[1,], ymax = trends.rot.up[1,]), fill = \"grey\") +\n  geom_hline(yintercept = 0, size = 0.5, linetype = \"dashed\") +\n  geom_line(data = NULL, aes(x = reddcts_mat$year, y = trends.rot[1,]), size = 1) +\n  xlab(\"Year\") +\n  ylab(\"Common trend\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"))\n# ptrend2 &lt;- ggplot() + \n#   geom_ribbon(data = NULL, aes(x = reddcts_mat$year, ymin = trends.rot.low[2,], ymax = trends.rot.up[2,]), fill = \"grey\") +\n#   geom_hline(yintercept = 0, size = 0.5, linetype = \"dashed\") +\n#   geom_line(data = NULL, aes(x = reddcts_mat$year, y = trends.rot[2,]), size = 1) +\n#   xlab(\"Year\") +\n#   ylab(\"Common trend 2\") +\n#   theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\")) + ylim(-6,9)\n\n# Plot loadings\npload1 &lt;- ggplot(data=NULL, aes(factor(pops.short, levels = pops.short), Z.rot[,1])) + \n  geom_hline(yintercept = 0, size = 0.5, color = \"grey50\") +\n  geom_hline(yintercept = 0.2, size = 0.5, linetype = \"dashed\", color = \"grey50\") +\n  geom_hline(yintercept = -0.2, size = 0.5, linetype = \"dashed\", color = \"grey50\") +\n  geom_bar(stat = \"identity\", width = 0.2, fill = \"black\") +\n  xlab(\"Population\") +\n  ylab(\"Loading\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))\n# pload2 &lt;- ggplot(data=NULL, aes(factor(pops.short, levels = pops.short), Z.rot[,2])) + \n#   geom_hline(yintercept = 0, size = 0.5, color = \"grey50\") +\n#   geom_hline(yintercept = 0.2, size = 0.5, linetype = \"dashed\", color = \"grey50\") +\n#   geom_hline(yintercept = -0.2, size = 0.5, linetype = \"dashed\", color = \"grey50\") +\n#   geom_bar(stat = \"identity\", width = 0.2, fill = \"black\") +\n#   xlab(\"Population\") +\n#   ylab(\"Loading\") +\n#   theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + ylim(-0.3,0.4)\n\n# combine plots\nggarrange(ptrend1, pload1, ncol = 2)\n\n\n\n\n\n\n\n\n\nPlot population-specific trend estimates\n\n\nCode\n# run kalman filter\nkf &lt;- MARSSkfss(topmod)\n\n# extract model components\nZ_mat &lt;- coef(topmod, type = \"matrix\")$Z  # Loadings (n_series x n_trends)\nxtT &lt;- kf$xtT                               # States (n_trends x time)\nVtT &lt;- kf$VtT                               # State covariance matrices (n_trends x n_trends x time)\n\n# compute fitted values and standard errors\nn_series &lt;- nrow(Z_mat)\nn_time &lt;- ncol(xtT)\n\nfitted_vals &lt;- Z_mat %*% xtT              # n_series x time\nse_vals &lt;- matrix(NA, n_series, n_time)   # standard errors\n\nfor (t in 1:n_time) {\n  Vt &lt;- VtT[, , t]\n  Var_yt &lt;- Z_mat %*% Vt %*% t(Z_mat)\n  se_vals[, t] &lt;- sqrt(diag(Var_yt))      # std dev for each series at time t\n}\n\n# construct 95% confidence intervals\nupper_band &lt;- fitted_vals + 1.96 * se_vals\nlower_band &lt;- fitted_vals - 1.96 * se_vals\n\n# plot\nas_tibble(t(fitted_vals)) %&gt;% \n  mutate(year = reddcts_mat$year) %&gt;% \n  gather(key = \"stream\", value = \"fitted\", -year) %&gt;% \n  mutate(stream = factor(stream, levels = pops)) %&gt;%\n  left_join(as_tibble(t(upper_band)) %&gt;% \n              mutate(year = reddcts_mat$year) %&gt;% \n              gather(key = \"stream\", value = \"fitted_up\", -year) %&gt;% \n              mutate(stream = factor(stream, levels = pops))) %&gt;%\n  left_join(as_tibble(t(lower_band)) %&gt;% \n              mutate(year = reddcts_mat$year) %&gt;% \n              gather(key = \"stream\", value = \"fitted_low\", -year) %&gt;% \n              mutate(stream = factor(stream, levels = pops))) %&gt;%\n  left_join(as_tibble(t(reddcts_mat_formatted)) %&gt;% \n              mutate(year = reddcts_mat$year) %&gt;% \n              gather(key = \"stream\", value = \"observed\", -year) %&gt;% \n              mutate(stream = factor(stream, levels = pops))) %&gt;%\n  ggplot() +\n  geom_ribbon(aes(x = year, ymin = fitted_low, ymax = fitted_up), fill = \"blue\", alpha = 0.2) +\n  geom_point(aes(x = year, y = observed)) +\n  geom_line(aes(x = year, y = fitted), color = \"blue\", size = 1) +\n  facet_wrap(~stream) +\n  xlab(\"Year\") +\n  ylab(\"Redds per km (standardized)\") +\n  theme_bw() + theme(panel.grid = element_blank(), axis.text = element_text(color = \"black\"), axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Trend Analysis</span>"
    ]
  }
]